name: Android Emulator Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  android-smoke:
    name: Android smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK (AOSP x86_64, API 29)
        uses: reactivecircus/android-emulator-runner@v2
        timeout-minutes: 20
        emulator-boot-timeout: 600
        with:
          api-level: 29
          target: default
          arch: x86_64
          force-avd-creation: true
          # Set lightweight options; disable audio and headless window for speed
          emulator-options: -no-window -no-audio -gpu swiftshader_indirect -no-snapshot -no-boot-anim -accel off
          script: |
            echo "Checking adb devices..."
            adb wait-for-device
            adb devices
            echo "Installing node dependencies..."
            npm ci --legacy-peer-deps
            echo "Running tests (unit + smoke)"
            npm test --silent
            echo "Starting Android native build - prebuilding (this may take a while)"
            # Generate native Android project from managed expo (prebuild)
            npx expo prebuild --platform android --no-install

            echo "Building and installing app to the emulator via expo run:android"

            # WAIT for the device to be recognized as 'device' (not 'offline') and for the boot to complete.
            echo "Ensuring ADB recognizes the emulator and boot is complete (timeout 120s)"
            # Ensure host connects to emulator port explicitly (some runners need this)
            adb connect 127.0.0.1:5554 || true
            adb connect localhost:5554 || true
            adb start-server || true
            # Wait for device online status
            MAX_WAIT=120
            WAITED=0
            INTERVAL=5
            DEVICE_STATE=""
            while [ "$WAITED" -lt $MAX_WAIT ]; do
              DEVICE_STATE=$(adb devices | awk '/emulator-5554/{print $2}') || true
              echo "Current device state: $DEVICE_STATE"
              if [ "$DEVICE_STATE" = "device" ]; then
                echo "Device is online"
                break
              fi
              if [ "$DEVICE_STATE" = "offline" ]; then
                echo "Device offline: restarting adb server"
                adb kill-server || true
                adb start-server || true
              fi
              sleep $INTERVAL
              WAITED=$((WAITED + INTERVAL))
            done
            if [ "$DEVICE_STATE" != "device" ]; then
              echo "Warning: device did not become 'device' within timeout. Proceeding anyway to capture logs." >&2
            fi

            # Wait for sys.boot_completed (some images use dev.bootcomplete)
            BOOTED=0
            WAITED=0
            while [ "$WAITED" -lt $MAX_WAIT ]; do
              BOOTED=$(adb -s emulator-5554 shell getprop sys.boot_completed 2>/dev/null || adb -s emulator-5554 shell getprop dev.bootcomplete 2>/dev/null || echo 0)
              BOOTED=$(echo "$BOOTED" | tr -d '\r')
              echo "Boot completed? $BOOTED"
              if [ "$BOOTED" = "1" ]; then
                echo "Boot complete"
                break
              fi
              sleep $INTERVAL
              WAITED=$((WAITED + INTERVAL))
            done
            if [ "$BOOTED" != "1" ]; then
              echo "Warning: boot property not 1 within timeout. Proceeding to build, but this may fail." >&2
            fi

            # Now attempt native build and install. Retry once if adb offline error occurs.
            npx expo run:android --no-dev --variant debug --no-packager --non-interactive || {
              echo "expo run:android failed on first attempt. Checking adb state(s)." >&2
              adb devices -l || true
              # If offline, try restarting adb and retry once
              if adb devices | grep -q 'offline'; then
                echo "Device offline detected; restarting adb and retrying..."
                adb kill-server || true
                adb start-server || true
                sleep 3
                adb wait-for-device || true
                npx expo run:android --no-dev --variant debug --no-packager --non-interactive || {
                  echo "expo run:android failed again. Capturing debug information..." >&2
                  adb -s emulator-5554 logcat -d || true
                  exit 1
                }
              else
                echo "expo run:android failed for another reason; exiting" >&2
                exit 1
              fi
            }
            
            # Give the device some time to finish launching
            sleep 10
            ps aux | grep expo || true
            # Extra emulator / qemu debug steps
            echo "=== Emulator processes ==="
            ps aux | grep -E 'emulator|qemu' || true
            echo "=== AVD directory listing ==="
            ls -la $HOME/.android/avd || true
            echo "=== Emulator log (if exists) ==="
            LOG_PATH=$(ls -1 $HOME/.android/avd/*.avd 2>/dev/null | head -n 1 || true)
            if [ -n "$LOG_PATH" ]; then
              echo "AVD path: $LOG_PATH"
              EMU_LOG="$LOG_PATH/emulator.log"
              if [ -f "$EMU_LOG" ]; then
                echo "----- emulator.log -----"
                tail -n 200 "$EMU_LOG" || true
                echo "----- end emulator.log -----"
              fi
              QEMU_LOG="$LOG_PATH/qemu.log"
              if [ -f "$QEMU_LOG" ]; then
                echo "----- qemu.log -----"
                tail -n 200 "$QEMU_LOG" || true
                echo "----- end qemu.log -----"
              fi
            fi
            adb devices
            echo "Smoke checks completed"

      - name: Collect ADB diagnostics (logcat)
        if: always()
        run: |
          echo "=== adb devices ==="
          adb devices -l || true
          echo "=== GETPROP sys.boot_completed ==="
          adb -s emulator-5554 shell getprop sys.boot_completed || true
          echo "=== adb shell dumpsys activity top (short) ==="
          adb -s emulator-5554 shell dumpsys activity activities | head -n 40 || true
          echo "=== adb logcat dump (last 5K chars) ==="
          adb -s emulator-5554 logcat -d || true

      - name: Collect installed packages and app path
        if: always()
        run: |
          echo "=== Installed packages (filtered for expo/clearsend) ==="
          adb -s emulator-5554 shell pm list packages | grep -E "expo|clearsend|com.clearsend" || true
          echo "=== Possible ClearSend app path detail ==="
          for p in $(adb -s emulator-5554 shell pm list packages | sed 's/package://g'); do adb -s emulator-5554 shell pm path $p || true; done | head -n 40 || true

      - name: Save ADB logs and packages to workspace
        if: always()
        run: |
          echo "Saving logcat and package list to workspace"
          adb -s emulator-5554 logcat -d > android-logcat.txt || true
          adb -s emulator-5554 shell pm list packages > android-packages.txt || true

      - name: Upload ADB diagnostics artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-diagnostics
          path: |
            android-logcat.txt
            android-packages.txt
